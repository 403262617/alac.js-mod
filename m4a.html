<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ALAC</title>
</head>
<body>
    <p>Open your favorite JS console! :)</p>
    <p>Make sure you run build.sh after every change.</p>
    <script src="lib/alac.js"></script>
    <script src="sink.js"></script>
    <script>
        // Load the CAF file
        var xhr = new XMLHttpRequest();
        //xhr.open("GET", "emerson/1-07 Scherzo_ Allegro vivo.caf", true);
        // xhr.open("GET", "eod-begin.caf", true);
        // xhr.open("GET", "out.caf", true);
        xhr.open("GET", "dumka.m4a", true);
        //xhr.open("GET", "02 - End of Daylight.caf", true);
        
        xhr.responseType = "arraybuffer";
        
        var genres = [
            "Blues", "Classic Rock", "Country", "Dance", "Disco",
    		"Funk", "Grunge", "Hip-Hop", "Jazz", "Metal",
    		"New Age", "Oldies", "Other", "Pop", "R&B",
    		"Rap", "Reggae", "Rock", "Techno", "Industrial",
    		"Alternative", "Ska", "Death Metal", "Pranks", "Soundtrack",
    		"Euro-Techno", "Ambient", "Trip-Hop", "Vocal", "Jazz+Funk",
            "Fusion", "Trance", "Classical", "Instrumental", "Acid",
    		"House", "Game", "Sound Clip", "Gospel", "Noise",
    		"AlternRock", "Bass", "Soul", "Punk", "Space", 
    		"Meditative", "Instrumental Pop", "Instrumental Rock", "Ethnic", "Gothic", 
    		"Darkwave", "Techno-Industrial", "Electronic", "Pop-Folk", "Eurodance", 
    		"Dream", "Southern Rock", "Comedy", "Cult", "Gangsta",
    		"Top 40", "Christian Rap", "Pop/Funk", "Jungle", "Native American",
    		"Cabaret", "New Wave", "Psychadelic", "Rave", "Showtunes",
    		"Trailer", "Lo-Fi", "Tribal", "Acid Punk", "Acid Jazz",
    		"Polka", "Retro", "Musical", "Rock & Roll", "Hard Rock",
    		"Folk", "Folk/Rock", "National Folk", "Swing", "Fast Fusion",
    		"Bebob", "Latin", "Revival", "Celtic", "Bluegrass",
    		"Avantgarde", "Gothic Rock", "Progressive Rock", "Psychedelic Rock", "Symphonic Rock",
    		"Slow Rock", "Big Band", "Chorus", "Easy Listening", "Acoustic", 
    		"Humour", "Speech", "Chanson", "Opera", "Chamber Music", "Sonata", 
    		"Symphony", "Booty Bass", "Primus", "Porn Groove", 
    		"Satire", "Slow Jam", "Club", "Tango", "Samba", 
    		"Folklore", "Ballad", "Power Ballad", "Rhythmic Soul", "Freestyle", 
    		"Duet", "Punk Rock", "Drum Solo", "A Capella", "Euro-House",
    		"Dance Hall"
        ];
                
        xhr.onload = function() {
            console.log('loaded file.');      
            var file = new Uint8Array(xhr.response);
            var data = new Data(file);
            
            var format = {},
                metadata = {},
                currentField = {},
                cookie = null,
                audioData = null;
            
            // Demux
            while(data.pos < data.length) {
                var len = data.readUInt32(),
                    type = data.readString(4);
                    
                if (len == 1)
                    throw "Extended size atoms are not supported.";
                
                //console.log(type);
                    
                switch (type) {
                    case 'ftyp':
                        if (data.readString(4) != 'M4A ') 
                            throw 'Not an M4A file.';

                        data.pos += len - 12;
                        break;
                    
                    // traverse into these types - they are container atoms
                    case 'moov':
                    case 'trak':
                    case 'mdia':
                    case 'minf':
                    case 'stbl':
                    case 'udta':
                    case 'ilst':
                        continue;
                    
                    case 'meta':
                        data.pos += 4 // random extra zeros...
                        continue;
                    
                    // from http://atomicparsley.sourceforge.net/mpeg-4files.html
                    case '©alb':
                    case '©arg':
                    case '©art':
                    case '©ART':
                    case 'catg':
                    case '©com':
                    case 'covr':
                    case 'cpil':
                    case '©cpy':
                    case 'cprt':
                    case '©day':
                    case 'desc':
                    case 'disk':
                    case '©gen': // custom gnres
                    case 'gnre': // standard ones
                    case '©grp':
                    case '©isr':
                    case 'keyw':
                    case '©lab':
                    case '©lal':
                    case '©lyr':
                    case '©nam':
                    case 'pcst':
                    case 'pgap':
                    case '©phg':
                    case '©prd':
                    case '©prf':
                    case '©prk':
                    case '©prl':
                    case 'purd':
                    case 'purl':
                    case 'rtng':
                    case '©swf':
                    case '©swr':
                    case 'tmpo':
                    case '©too':
                    case 'trkn':
                    case '©wrt':
                        currentField = type;
                        continue;
                        
                    case 'data':
                        switch (currentField) {
                            case 'disk':
                            case 'trkn':
                                var startpos = data.pos - 8;
                                data.pos += 10; // reserved
                                    
                                metadata[currentField] = data.readUInt16() + ' of ' + data.readUInt16();
                                data.pos = startpos + len;
                                break;
                           
                            case 'cpil':
                            case 'pgap':
                            case 'pcst':
                                data.pos += 8
                                metadata[currentField] = data.readUInt8() == 1;
                                break;
                            
                            case 'gnre':
                                data.pos += 8;
                                metadata[currentField] = genres[data.readUInt16() - 1];
                                break;
                            
                            case 'rtng':
                                data.pos += 8;
                                var rating = data.readUInt8();
                                metadata[currentField] = rating == 2 ? 'Clean' : rating != 0 ? 'Explicit' : 'None';
                                break;
                                
                            case 'tmpo':
                                data.pos += 8;
                                metadata[currentField] = data.readUInt16();
                                break;
                                
                            case 'covr':
                                data.pos += 8;
                                var format = '';
                                
                                if (data.stringAt(1, 3) == "PNG") {
                                    format = 'png';
                                }
                                else if (data.stringAt(0, 3) == '\xFF\xD8\xFF') {
                                    format = 'jpeg';
                                }
                                else {
                                    throw "Unsupported cover image format."
                                }
                                
                                // Copy the image data into a new buffer
                                var buf = new ArrayBuffer(len - 16),
                                    imgData = new Uint8Array(buf);
                                    
                                imgData.set(data.slice(data.pos, data.pos + len - 16));
                                
                                // Use the BlobBuilder API to construct a URL
                                var BlobBuilder = window.BlobBuilder || window.WebKitBlobBuilder || window.MozBlobBuilder,
                                    URL = window.URL || window.webkitURL;
                                    
                                if (BlobBuilder) {
                                    var blob = new BlobBuilder();
                                    blob.append(buf);
                                    blob = blob.getBlob('image/' + format);
                                    
                                    metadata[currentField] = URL.createObjectURL(blob);
                                }
                                else {
                                    // Generate a data URL
                                    var str = '';
                                    for (var i = 0, len = imgData.length; i < len; i++)
                                        str += String.fromCharCode(imgData[i]);
                                    
                                    metadata[currentField] = "data:image/" + format + ";base64," + btoa(str);
                                }
                                
                                // Show the image (for testing purposes)
                                var img = document.createElement("img");
                                img.src = metadata[currentField];
                                document.body.appendChild(img);
                                    
                                data.pos += len - 16;
                                break;
                                
                            default:
                                metadata[currentField] = decodeURIComponent(escape(data.readString(len - 8))); // UTF-8 decode
                        }
                        break;
                    
                    // skip these types    
                    case 'mvhd':
                    case 'elst':
                    case 'iods':
                    case 'tkhd':
                    case 'edts':
                    case 'mdhd':
                    case 'hdlr': // version, flags, manufacturer, etc.
                    case 'smhd':
                    case 'dinf':
                    case 'stsc':
                    case 'stco':
                    case 'stts': // time to sample
                    case 'stsz': // something...
                    case '----': // some weird iTunes thing
                    case 'free':
                    case 'skip':
                        data.pos += len - 8;
                        break;
                        
                    case 'stsd':
                        var maxpos = data.pos + len - 8;
                        
                        // version and flags
                        data.pos += 4;
                        
                        var numEntries = data.readUInt32();
                        if (numEntries != 1) 
                            throw "Only expecting one entry in sample description atom!";
                        
                        //for i in [0...numEntries]
                        
                        data.pos += 4; // size
                        
                        format.formatID = data.readString(4);
                        if (format.formatID != 'alac')
                            throw 'ALAC data not found.';
                        
                        data.pos += 6; // reserved
                        
                        if (data.readUInt16() != 1)
                            throw "Unknown version.";
                            
                        // skip revision level and vendor
                        data.pos += 6;
                        data.pos += 2; // reserved
                        
                        format.channelsPerFrame = data.readUInt16();
                        format.bitsPerChannel = data.readUInt16();
                        
                        // skip compression id and packet size
                        data.pos += 4;
                        
                        format.sampleRate = data.readUInt16();
                        data.pos += 2;
                        
                        // cookie
                        cookie = data.slice(data.pos, maxpos)
                        data.pos = maxpos;
                        
                        break;
                        
                    case 'mdat':
                        audioData = data.slice(data.pos, data.pos + len);
                        data.pos += len;
                        break;
                        
                     default:
                        console.log('Unknown chunk type:', type);
                        data.pos += len - 8;
                        //return;
                }
            }
            
            if (!cookie || !audioData) {
                throw 'Cookie and audio data not found.';
            }
            
            console.log(metadata);
            return;
            
            // Decode
            var decoder = new ALACDecoder(cookie);
            var bitbuffer = new BitBuffer(audioData);
            
            console.log('format', format);
            console.time("decode");
            
            var outputs = [], status = 0;
            
            while (status === 0) {
              // console.log("Packet", ++times);
              
              var out = decoder.decode(bitbuffer, 0, decoder.config.frameLength, format.channelsPerFrame);
              
              if (out[1]) {
                var array = new Int16Array(out[1]);
                outputs.push(array);
              }
              
              status = out[0];
              delete out;
            }
            
            console.timeEnd('decode');
            return;
            
            if (outputs.length > 0) {
                eod = new Float32Array(outputs.length * outputs[0].length);
            
                for (var i = 0; i < outputs.length; i++) {
                  for (var j = 0; j < outputs[0].length; j++) {
                    eod[i * outputs[0].length + j] = outputs[i][j] / Math.pow(2, 15);
                  }
                }
            
                var kthxbai = 0;
            
                var sink = Sink(function(buffer, channelCount){
                  for (var i = 0; i < buffer.length; i++){
                    buffer[i] = eod[kthxbai + i];
                  }
              
                  kthxbai += buffer.length;
              
                  if (kthxbai > eod.length) {
                    return sink.kill();
                  }
                }, format.channelsPerFrame, null, format.sampleRate);
            }
            else {
                console.log("ERROR!");
            }
        }
        
        xhr.send(null);
    </script>
</body>
</html>
