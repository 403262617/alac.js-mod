<!DOCTYPE html>
<html>
<head>
    <title>ALAC</title>
</head>
<body>
    <p>Open your favorite JS console! :)</p>
    <p>Make sure you run build.sh after every change.</p>
    
    <!--<script src="lib/aurora.js"></script>
    <script src="lib/alac.js"></script>-->
    <script src="sink.js"></script>
    
    <script>
        function WorkerPlayer() {
            this.events = {};
            this.worker = new Worker("worker.js");
            
            // Emit events
            var _this = this;
            this.worker.onmessage = function(e) {
                var evts = _this.events[e.data[0]];
                if (!evts) return;

                var args = Array.prototype.slice.call(e.data, 1);
                for (var i = 0; i < evts.length; i++) {
                    evts[i].apply(null, args);
                }
            }
            
            this.worker.onerror = function(e) {
                console.log(e);
            }
        }
        
        WorkerPlayer.prototype = {
            on: function(evt, fn) {
                var evts = this.events[evt] || (this.events[evt] = []);
                evts.push(fn);
            },
            
            off: function off(evt, fn) {
                var evts = this.events[evt];
                if (!evts) return;

                var index = evts.indexOf(fn);
                ~index && evts.splice(index, 1);
            },
            
            once: function once(evt, fn) {
                var _this = this;
                this.on(evt, function() {
                    _this.off(evt, arguments.callee);
                    fn.apply(null, arguments);
                });
            },
            
            start: function(url) {
                this.worker.postMessage(['start', url]);
            },
            
            read: function(bufferLength, fn) {
                this.once('response', fn);
                this.worker.postMessage(['read', bufferLength]);
            }
        }
        
        var player = new WorkerPlayer(),
            paused = false;
            
        // Shim console.log for workers
        player.on('log', function() { 
            console.log.apply(console, arguments)
        });
        
        player.on('ready', function() {
            var frames = [], offset = 0;
            var sink = Sink(function(buffer, channelCount) {
                if(paused) return;
                
                if (frames.length) {
                    var cur = frames[0];
                    
                    if (cur.length == buffer.length) {
                        buffer.set(cur);
                        frames.shift();
                    }
                    else {
                        for (var i = 0; i < buffer.length; i++) {
                            if (offset >= cur.length) {
                                frames.shift();
                                cur = frames[0];
                                offset = 0;
                                if (!cur) break;
                            }
                            
                            buffer[i] = cur[offset++];
                        }
                    }
                }
                
                player.read(buffer.length, function(f) {
                    frames.push(f);
                });
            }, 2, null, 44100);
            
            sink.on('error', function(e){ console.log(e) })
        });
        
        player.start("lovestruck.caf");
    </script>
</body>
</html>
