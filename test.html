<!DOCTYPE html>
<html>
<head>
    <title>ALAC</title>
</head>
<body>
    <p>Open your favorite JS console! :)</p>
    <p>Make sure you run build.sh after every change.</p>
    <script src="lib/alac.js"></script>
    <script src="vendor/core.js/js/core.js"></script>
    <script>
        // Load the CAF file
        var xhr = new XMLHttpRequest();
        xhr.open("GET", "out.caf", true);
        //xhr.open("GET", "cut.caf", true);
        //xhr.open("GET", "02 - End of Daylight.caf", true);
        
        xhr.responseType = "arraybuffer";
        
        xhr.onload = function() {
            var file = new Uint8Array(xhr.response);
            var data = new Data(file);
            
            if (data.readString(4) !== 'caff')
                return console.log("Invalid CAF, does not begin with 'caff'");
                
            var container = data.struct({
                fileVersion: 'uint16',
                fileFlags: 'uint16'
            });
            
            console.log('container', container);
            
            if (data.readString(4) !== 'desc')
                return console.log("Invalid CAF, header is not followed by 'desc'");
                
            if (data.readUInt64() !== 32)
                return console.log("Invalid 'desc' size, should be 32");
            
            var format = data.struct({
                sampleRate: 'double',
                formatID: 'string[4]',
                formatFlags: 'uint32',
                bytesPerPacket: 'uint32',
                framesPerPacket: 'uint32',
                channelsPerFrame: 'uint32',
                bitsPerChannel: 'uint32'
            });
            
            console.log('format', format);
            
            if (format.formatID !== 'alac')
                return console.log("CAF does not contain Apple Lossless audio");
            
            while (data.pos < data.length) {
                var type = data.readString(4);
                var size = data.readUInt64();
                
                switch (type) {
                    case 'kuki':
                        console.log("Found cookie, initializing decoder");
                        
                        var decoder = new ALACDecoder(data.slice(data.pos, data.pos + size));
                        break;
                        
                    case 'data':
                        console.log("Found data");
                        
                        var out = decoder.decode(data.slice(data.pos + 4, data.pos + size - 8), 0, 4096, 2);
                        console.log("output", out);
                        return;
                        
                    default:
                        console.log("Found random type, '" + type + "'");
                }
                
                data.pos += size;
            }
        }
        
        xhr.send(null);
    </script>
</body>
</html>
