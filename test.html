<!DOCTYPE html>
<html>
<head>
    <title>ALAC</title>
</head>
<body>
    <p>Open your favorite JS console! :)</p>
    <p>Make sure you run build.sh after every change.</p>
    
    <script src="lib/aurora.js"></script>
    <script src="lib/alac.js"></script>
    <script src="sink.js"></script>
    
    <script>
      var bus = {
        send: function () {
          console.log("Message Bus: ", arguments)
        }
      }
      
      var httpSource = new Aurora.HTTPSource("Source")
      var cafDemuxer = new Aurora.CAFDemuxer("Demuxer")
      var alacDecoder = new Aurora.ALACDecoder("Decoder")
      var buffer = new Aurora.Queue("Buffer")
      
      httpSource.url = "eod-begin.caf"
      // httpSource.url = "02 - End of Daylight.caf"
      // httpSource.url = "planets.caf"
      
      httpSource.messagebus = bus
      cafDemuxer.messagebus = bus
      alacDecoder.messagebus = bus
      
      httpSource.outputs.data = cafDemuxer.inputs.data
      
      cafDemuxer.outputs.metadata = alacDecoder.inputs.metadata
      cafDemuxer.outputs.cookie = alacDecoder.inputs.cookie
      cafDemuxer.outputs.data = alacDecoder.inputs.data
      
      alacDecoder.outputs.audio = buffer.inputs.contents
      
      buffer.onHighwaterMark = function () {
        console.log("Hitting High-Water Mark, Aurora o'hoy! Lets start playing!")
        
        var output = buffer.outputs.contents
        
        var frame = new Int16Array(output.receive().data), frameOffset = 0
        
        var sink = Sink(function(buffer, channelCount) {
          var bufferOffset = 0
          
          if (!frame) {
            return
          }
          
          while (bufferOffset < buffer.length) {
            for (var i = 0; i < Math.min(frame.length - frameOffset, buffer.length - bufferOffset); i++) {
              buffer[bufferOffset + i] = frame[frameOffset + i] / 0x7FFF
            }
            
            bufferOffset += i, frameOffset += i
            
            if (frameOffset == frame.length) {
              frame = new Int16Array(output.receive().data), frameOffset = 0
            }
          }
        }, 2, null, 44100);
        
      }
      
      buffer.start()
      alacDecoder.start()
      cafDemuxer.start()
      httpSource.start()
    </script>
</body>
</html>
